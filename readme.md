# 実行環境セットアップマニュアル

## 概要

- Dockerインストール環境を使用します
- Dockerを用いてアプリケーション実行環境をセットアップします
- セットアップした環境にアプリケーションをデプロイします

### 1. 事前準備

- DB設定値の変更
    - .env ファイルの環境変数を適宜変更してください
    - my.cnf ファイルの設定値を適宜変更してください

### 2. セットアップ実行

1. docker-compose を実行します

```
docker-compose up -d
```

2. Docker 環境にアクセスします

    2-1. バックエンドAPI(api)にアクセス

    ```
    docker-compose exec api bash
    ```

    * ここからはDocker環境内(apiディレクトリ直下)での操作です *

    - npm をインストール(アップデート)します

    ```
    npm install
    npm update
    ```

    - DB マイグレーションを実行します

    ```
    npx prisma migrate dev
    ```

    - api サーバを起動します

    ```
    npm run dev
    ```

    2-2. フロントエンドアプリケーション(app)にアクセス

    ```
    docker-compose exec app bash
    ```

    * ここからはDocker環境内(appディレクトリ直下)での操作です *

    - npm をインストールします

    ```
    npm install
    npm update
    ```

    - app サーバを起動します

    ```
    npm run serve
    ```

3. ブラウザからアクセスして起動を確認します

# DB操作マニュアル

## 概要

1. マイグレーション
    - DB 構築と同時にレコードをセットします

2. シーディング
    - 既存のDB にレコードをセットします（既存のレコードは上書きされます）

3. インサート
    - 既存のDB にレコードを追加します（既存のレコードは残ります）

### 1.マイグレーション

1. 初回

- ファイル名を「data.json」とした追加用JSONデータファイルを用意します
- 用意したJSONデータファイルをapi ディレクトリ直下に配置します
- api ディレクトリへ移動します
- マイグレーション用のコマンドを実行します
    - ※途中でマイグレーション名を付けることを求められた場合は、バージョンや日付などを適宜設定してください

（コマンド操作例）
```
cd ./api
npx prisma migrate dev
```

2. リセット：DBスキーマ（テーブル構造やデータ型等）を変更した場合に利用

＊既存のレコードデータを削除した上で、レコードを追加します。（IDはリセットされます）

- ファイル名を「data.json」とした追加用JSONデータファイルを用意します
- 用意したJSONデータファイルをapi ディレクトリ直下に配置します
- api ディレクトリへ移動します
- リセット用のコマンドを実行します

（コマンド操作例）
```
cd ./api
npx prisma migrate reset
```

### 2.シーディング

＊既存のレコードデータを削除した上で、レコードを追加します。（IDはリセットされません）

- ファイル名を「data.json」とした追加用JSONデータファイルを用意します
- 用意したJSONデータファイルをapi ディレクトリ直下に配置します
- api ディレクトリへ移動します
- シーディング用のコマンドを実行します

（コマンド操作例）
```
cd ./api
npx prisma db seed
```

### 3.インサート

＊既存のレコードデータの後に、レコードを追加します。（IDや主キーが重複するとエラーになります）

- ファイル名を「data_insert.json」とした追加用JSONデータファイルを用意します
- 用意したJSONデータファイルをapi ディレクトリ直下に配置します
- api ディレクトリへ移動します
- インサート用のコマンドを実行します

（コマンド操作例）
```
cd ./api
npx ts-node prisma/insert/start.ts
```

### appendix

1. JSON データファイルについて

- 基本のファイル名は「data.json」としてください
- インサート用のファイル名は「data_insert.json」としてください

2. Prisma Studio

DB 内のテーブルやレコードをGUI で管理可能な付属ツールです
コマンド操作で起動することができます(コマンド実行後に自動的にブラウザが起動します)

（コマンド操作例）
```
cd ./api
npx prisma studio
```
